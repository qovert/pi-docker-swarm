---
- name: Deploy Node Exporter Full Dashboard
  hosts: manager_nodes
  become: true
  gather_facts: true

  vars:
    monitoring_stack_name: "monitoring"
    monitoring_data_path: "/data/monitoring"
    clean_dashboard_path: "./config/node-exporter-full-clean.json"

  tasks:
    - name: Ensure dashboards directory exists with proper permissions
      ansible.builtin.file:
        path: "{{ monitoring_data_path }}/grafana-dashboards"
        state: directory
        mode: '0755'
        owner: '472'
        group: '0'

    - name: Deploy Node Exporter Full dashboard
      ansible.builtin.copy:
        src: "{{ clean_dashboard_path }}"
        dest: "{{ monitoring_data_path }}/grafana-dashboards/node-exporter-full.json"
        mode: '0644'
        owner: '472'
        group: '0'

    - name: Restart Grafana to reload dashboards
      ansible.builtin.command: docker service update --force {{ monitoring_stack_name }}_grafana

    - name: Wait for Grafana to restart and process dashboards
      ansible.builtin.pause:
        seconds: 45

    - name: Test Grafana health
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:3000/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      retries: 5
      delay: 10
      until: grafana_health.status == 200
      ignore_errors: true

    - name: Check available dashboards via API
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:3000/api/search?type=dash-db"
        method: GET
        user: admin
        password: "{{ grafana_admin_password | default('admin123') }}"
        force_basic_auth: true
        return_content: true
      register: dashboard_list
      ignore_errors: true

    - name: Display deployment results
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "ğŸš€ Node Exporter Full Dashboard Deployed!"
          - "========================================"
          - ""
          - "Grafana Status: {{ 'Healthy' if grafana_health.status == 200 else 'Issues detected' }}"
          - "Dashboards Found: {{ (dashboard_list.json | length) if dashboard_list.json is defined else 'Unknown' }}"
          - ""
          - "ğŸ¯ Access Grafana: http://{{ ansible_default_ipv4.address }}:3000"
          - "ğŸ”‘ Login: {{ grafana_admin_user | default('admin') }} / {{ grafana_admin_password | default('admin123') }}"
          - ""
          - "ğŸ“Š Expected Dashboards:"
          - "- Node Exporter Full - Pi Cluster (comprehensive monitoring)"
          - "- Pi Docker Swarm Basic (simple overview)"
          - ""
          - "ğŸ’¡ The Node Exporter Full dashboard includes:"
          - "- 31 detailed monitoring panels"
          - "- CPU, Memory, Disk, Network metrics"
          - "- System load and process monitoring"
          - "- Hardware temperature tracking"
          - "- File system usage"
          - "- Network interface statistics"
          - ""
          - "â±ï¸  Wait 2-3 minutes for all panels to load data"
